name: Run Tox
description: Install requirements and run tox with caching

inputs:
  main-file:
    description: 'Python file for binary'
    type: string
    required: true
  additional-files:
    description: 'Additional files to copy to distribution'
    type: string
    required: false
    default: ''
  hidden-imports:
    description: 'Hidden imports for PyInstaller'
    type: string
    required: false
    default: ''

runs:
  using: "composite"

  steps:
    - name: Install PyInstaller
      run: python -m pip install pyinstaller
      shell: bash

    - name: Cache build venv
      uses: actions/cache@v3
      with:
        path: build/.env
        key: build-env-${{ runner.os }}-${{ env.PYTHON_VERSION }}-${{ hashFiles('**/requirements*.txt', 'pyproject.toml') }}
        restore-keys: |
          build-env-${{ runner.os }}-${{ env.PYTHON_VERSION }}

    - name: Building
      run: |
        python -m kiss_cf.build.pyinstaller \
          --main-file ${{ inputs.main-file }} \
          --additional-files "${{ inputs.additional-files }}" \
          --hidden-imports "${{ inputs.hidden-imports }}" \
          --debug
      shell: bash

    - name: Upload dist
      uses: actions/upload-artifact@v4
      with:
        name: build_${{ runner.os }}
        path: build/dist
        retention-days: 2
